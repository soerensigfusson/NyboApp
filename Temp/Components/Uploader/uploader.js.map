{"version":3,"sources":["uploader.js"],"names":["uploaderDirective","$inject","angular","module","directive","$timeout","storage","firebase","storageRef","ref","imagesRef","child","restrict","link","scope","uploader","element","attr","console","log","addEventListener","handleFiles","bind","callback","event","fileList","target","files","file","i","thumbnaildata","Thumbnail","maxWidth","maxHeight","onSuccess","data","createThumbnail","name","put","then","snapshot","length","options","onError","prototype","detectVerticalSquash","elem","naturalHeight","undefined","alpha","canvas","ctx","ey","ih","py","ratio","sy","document","createElement","width","height","getContext","drawImage","getImageData","type","match","createThumbnailFromImageFile","createThumbnailFromVideoFile","fileReader","FileReader","createThumbnailFromUrl","result","readAsDataURL","createVideoThumbnailFromUrl","URL","createObjectURL","videoUrl","canPlay","videoElem","style","body","appendChild","canPlayType","getThumbnailDataURL","videoWidth","videoHeight","removeChild","src","imageUrl","crossOrigin","imageElem","onload","onerror","getResizeInformation","srcWidth","srcHeight","info","srcX","srcY","trgWidth","trgHeight","srcRatio","optWidth","optHeight","trgRatio","elemWidth","elemHeight","vertSquashRatio","toDataURL"],"mappings":"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","file":"uploader.js","sourcesContent":["(function() {\n\n    uploaderDirective.$inject = [\"$timeout\"];\n    angular.module('App.Components.Uploader', [])\n        .directive('uploader', uploaderDirective);\n\n    function /*@ngInject*/ uploaderDirective($timeout) {\n        var storage = firebase.storage();\n\n        // Create a storage reference from our storage service\n        var storageRef = storage.ref();\n        var imagesRef = storageRef.child('images');\n\n        var directive = {\n            restrict: 'A',\n            link: link,\n            scope: {\n                uploader: '&'\n            }\n        };\n\n        function link(scope, element, attr) {\n            console.log('link');\n            element[0].addEventListener('change', handleFiles.bind(this, scope.uploader), false);\n        }\n\n        function handleFiles(callback, event) {\n            var fileList = event.target.files; /* now you can work with the file list */\n            for (var i = 0; i < fileList.length; i++) {\n                var file = fileList[i];\n                let thumbnaildata = '';\n\n                new Thumbnail({\n                    maxWidth: 200,\n                    maxHeight: 200,\n                    file: file,\n                    onSuccess: function(data) {\n                        thumbnaildata = data;\n                    }\n                }).createThumbnail();\n\n\n                let ref = imagesRef.child(file.name);\n                ref.put(file).then(function(snapshot) {\n                    callback()(snapshot, thumbnaildata, file.name, ref);\n                });\n\n\n            }\n        }\n\n        return directive;\n    }\n\n\n\n    function Thumbnail(options) {\n        this.options = {\n            file: options.file,\n            maxWidth: options.maxWidth || 120,\n            maxHeight: options.maxHeight || 120,\n            onError: options.onError && options.onError.bind(this),\n            onSuccess: options.onSuccess && options.onSuccess.bind(this)\n        };\n    };\n\n    Thumbnail.prototype.detectVerticalSquash = function(elem) {\n        if (elem.naturalHeight === undefined) {\n            return 1;\n        }\n        var alpha, canvas, ctx, data, ey, ih, py, ratio, sy;\n        ih = elem.naturalHeight;\n        canvas = document.createElement('canvas');\n        canvas.width = 1;\n        canvas.height = ih;\n        ctx = canvas.getContext('2d');\n        ctx.drawImage(elem, 0, 0);\n        data = ctx.getImageData(0, 0, 1, ih).data;\n        sy = 0;\n        ey = ih;\n        py = ih;\n        while (py > sy) {\n            alpha = data[(py - 1) * 4 + 3];\n            if (alpha === 0) {\n                ey = py;\n            } else {\n                sy = py;\n            }\n            py = (ey + sy) >> 1;\n        }\n        ratio = py / ih;\n        if (ratio === 0) {\n            return 1;\n        } else {\n            return ratio;\n        }\n    };\n\n    Thumbnail.prototype.createThumbnail = function() {\n        if (this.options.file.type.match(/image.*/)) {\n            this.createThumbnailFromImageFile();\n        } else if (this.options.file.type.match(/video.*/)) {\n            this.createThumbnailFromVideoFile();\n        } else if (this.options.onError) {\n            this.options.onError();\n        }\n    };\n\n    Thumbnail.prototype.createThumbnailFromImageFile = function() {\n        var fileReader = new FileReader();\n        fileReader.addEventListener('load', function() {\n            this.createThumbnailFromUrl(fileReader.result);\n        }.bind(this));\n        fileReader.readAsDataURL(this.options.file);\n    };\n\n    Thumbnail.prototype.createThumbnailFromVideoFile = function() {\n        this.createVideoThumbnailFromUrl(URL.createObjectURL(this.options.file));\n    };\n\n    Thumbnail.prototype.createVideoThumbnailFromUrl = function(videoUrl) {\n        var canPlay, videoElem;\n        videoElem = document.createElement('video');\n        videoElem.style = 'display: none';\n        document.body.appendChild(videoElem);\n        canPlay = videoElem.canPlayType(this.options.file.type);\n        if (canPlay === 'no' || canPlay === '') {\n            if (this.options.onError) {\n                this.options.onError();\n            }\n            return;\n        }\n        videoElem.addEventListener('loadeddata', function() {\n            if (this.options.onSuccess) {\n                this.options.onSuccess(\n                    this.getThumbnailDataURL(videoElem, videoElem.videoWidth, videoElem.videoHeight)\n                );\n            }\n            document.body.removeChild(videoElem);\n        }.bind(this), false);\n        videoElem.addEventListener('error', function() {\n            if (this.options.onError) {\n                this.options.onError();\n            }\n            document.body.removeChild(videoElem);\n        }.bind(this), false);\n        videoElem.src = videoUrl;\n    };\n\n    Thumbnail.prototype.createThumbnailFromUrl = function(imageUrl, crossOrigin) {\n        var imageElem = document.createElement('img');\n        if (crossOrigin) {\n            imageElem.crossOrigin = crossOrigin;\n        }\n        if (this.options.onSuccess) {\n            imageElem.onload = function() {\n                this.options.onSuccess(\n                    this.getThumbnailDataURL(imageElem, imageElem.width, imageElem.height)\n                );\n            }.bind(this);\n        }\n        if (this.options.onError) {\n            imageElem.onerror = this.options.onError;\n        }\n        imageElem.src = imageUrl;\n    };\n\n    Thumbnail.prototype.getResizeInformation = function(srcWidth, srcHeight) {\n        var info = {\n            srcX: 0,\n            srcY: 0,\n            srcWidth: srcWidth,\n            srcHeight: srcHeight,\n            trgWidth: undefined,\n            trgHeight: undefined\n        };\n        var srcRatio = srcWidth / srcHeight;\n        var optWidth = this.options.maxWidth;\n        var optHeight = this.options.maxHeight;\n        if (!optWidth && !optHeight) {\n            optWidth = info.srcWidth;\n            optHeight = info.srcHeight;\n        } else if (!optWidth) {\n            optWidth = srcRatio * optHeight;\n        } else if (!optHeight) {\n            optHeight = (1 / srcRatio) * optWidth;\n        }\n        var trgRatio = optWidth / optHeight;\n        if (srcHeight < optHeight || srcWidth < optWidth) {\n            // this code fails if only one src is below opt\n            info.trgHeight = info.srcHeight;\n            info.trgWidth = info.srcWidth;\n        } else {\n            if (srcRatio > trgRatio) {\n                info.srcHeight = srcHeight;\n                info.srcWidth = info.srcHeight * trgRatio;\n            } else {\n                info.srcWidth = srcWidth;\n                info.srcHeight = info.srcWidth / trgRatio;\n            }\n        }\n        info.srcX = (srcWidth - info.srcWidth) / 2;\n        info.srcY = (srcHeight - info.srcHeight) / 2;\n        if (info.trgWidth === undefined) {\n            info.trgWidth = optWidth;\n        }\n        if (info.trgHeight === undefined) {\n            info.trgHeight = optHeight;\n        }\n        return info;\n    };\n\n    Thumbnail.prototype.getThumbnailDataURL = function(elem, elemWidth, elemHeight) {\n        var vertSquashRatio = this.detectVerticalSquash(elem);\n        var info = this.getResizeInformation(elemWidth, elemHeight);\n        var canvas = document.createElement('canvas');\n        canvas.width = info.trgWidth;\n        canvas.height = info.trgHeight;\n        canvas.getContext('2d').drawImage(elem,\n            info.srcX, info.srcY,\n            info.srcWidth, info.srcHeight,\n            0, 0,\n            info.trgWidth, info.trgHeight / vertSquashRatio\n        );\n        return canvas.toDataURL('image/png');\n    };\n\n})();\n"]}